<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Structures - GerMaCrise</title>
  <style>
    body { margin:0; font-family:Arial,sans-serif; transition: background-color 0.3s, color 0.3s; }
    body.light { background-color:#ffffff; color:#000000; }
    body.dark { background-color:#000000; color:#ffd700; }

    header { padding:10px; font-size:1.2em; font-weight:bold; }
    h2 { margin-top:0; }

    .form-section { margin:15px; }
    label { display:block; margin-top:10px; }
    input { width:100%; padding:5px; margin-top:3px; }
    button { margin-top:10px; padding:5px 10px; cursor:pointer; }

    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #999; padding:5px; text-align:left; }
    th { background-color:rgba(0,0,0,0.1); }

    /* Adaptation th√®me */
    body.dark table th { background-color:rgba(255,215,0,0.2); }
    body.dark input, body.dark button { background-color:#333; color:#ffd700; border:1px solid #ffd700; }

    p.instruction { font-size:0.9em; color:gray; margin-top:5px; }
  </style>
</head>
<body class="light">
  <header>Gestion des structures - GerMaCrise</header>

  <div class="form-section">
    <h2>Ajouter / Modifier une structure</h2>
    <label>Nom <input type="text" id="nomStructure"></label>
    <button onclick="ajouterStructure()">Ajouter / Modifier</button>
    <button onclick="resetForm()">Annuler</button>
  </div>

  <div class="form-section">
    <h2>Liste des structures</h2>
    <table id="tableStructures">
      <thead>
        <tr><th>Nom</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="exporterJSON()">üì• Exporter en JSON</button>
    <p class="instruction">
      ‚ö†Ô∏è Pour mettre √† jour la source, d√©placez le fichier t√©l√©charg√© dans le dossier <code>json/</code>.
    </p>
  </div>

  <script>
    // Adaptation th√®me clair/sombre depuis parent
    window.addEventListener('message', e => {
      if(e.data.theme) document.body.className = e.data.theme;
    });

    let structures = [];
    let editIndex = null;

    // Charger structures depuis json/structure.json, sinon localStorage
    async function chargerStructures() {
      try {
        const resp = await fetch("json/structure.json");
        if(!resp.ok) throw new Error("Fichier JSON introuvable");
        structures = await resp.json();
        console.log("Structures charg√©es depuis json/structure.json");
      } catch(e) {
        console.warn("Chargement depuis localStorage", e);
        const data = localStorage.getItem("structures");
        structures = data ? JSON.parse(data) : [];
      }
      afficherStructures();
    }

    function sauvegarderStructures() {
      localStorage.setItem("structures", JSON.stringify(structures));
    }

    function ajouterStructure() {
      const nom = document.getElementById('nomStructure').value.trim();
      if(!nom) {
        alert("Veuillez remplir le nom de la structure");
        return;
      }

      if(editIndex !== null) {
        structures[editIndex] = {nom};
        editIndex = null;
      } else {
        structures.push({nom});
      }

      sauvegarderStructures();
      afficherStructures();
      resetForm();
    }

    function afficherStructures() {
      const tbody = document.getElementById('tableStructures').querySelector('tbody');
      tbody.innerHTML = '';
      structures.forEach((s, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.nom}</td>
          <td>
            <button onclick="modifierStructure(${index})">‚úè</button>
            <button onclick="supprimerStructure(${index})">üóë</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function modifierStructure(index) {
      document.getElementById('nomStructure').value = structures[index].nom;
      editIndex = index;
    }

    function supprimerStructure(index) {
      if(confirm("Supprimer cette structure ?")) {
        structures.splice(index,1);
        sauvegarderStructures();
        afficherStructures();
      }
    }

    function resetForm() {
      document.getElementById('nomStructure').value = '';
      editIndex = null;
    }

    function exporterJSON() {
      const dataStr = JSON.stringify(structures, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "structure.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialisation
    chargerStructures();
  </script>
</body>
</html>
