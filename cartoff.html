<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>cartoff - V1.5-plan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="css/leaflet.css" />
<style>
html, body { margin:0; height:100%; }
#map { width:100%; height:100vh; background:#ccc; transition: background 0.3s; }

.sidebar { 
  position:absolute; top:10px; right:10px; z-index:2000; 
  background:white; padding:10px; border-radius:8px; 
  box-shadow:0 2px 6px rgba(0,0,0,0.3); max-width:320px; 
  font-family:Arial,sans-serif; font-size:14px; 
  user-select:none; transition: background 0.3s, color 0.3s;
}
.sidebar.dark { background:#222; color:#eee; box-shadow:0 2px 6px rgba(0,0,0,0.6);}
.sidebar-header { cursor: grab; font-weight:bold; margin-bottom:8px; }
details summary { cursor:pointer; font-weight:bold; }
details { margin-bottom:8px; }
label { cursor:pointer; display:block; margin-bottom:6px; }

#coords { 
  position:absolute; bottom:10px; left:10px; z-index:3000; 
  background:rgba(255,255,255,0.92); padding:6px 10px; 
  border-radius:6px; font-family:Arial,sans-serif; font-size:13px; 
  box-shadow:0 1px 4px rgba(0,0,0,0.3); min-width:320px; 
  user-select:none; pointer-events:none; transition: background 0.3s, color 0.3s;
}

#legend { margin-top:10px; border-top:1px solid #ccc; padding-top:8px; font-size:13px; }
#errorMessages { color:red; font-size:12px; margin-top:8px; }

#sidebarLogo { display:block; margin:10px auto 0 auto; max-width:160px; }

#versionFloating{
  position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
  z-index:4000; background: rgba(0,0,0,0.7); color:white; 
  padding:6px 10px; border-radius:6px; font-family:Arial,sans-serif; font-size:12px; 
  cursor:move; user-select:none; text-align:center;
}

body.dark #map { background:#444; }
body.dark #coords { background: rgba(50,50,50,0.85); color:white; }

.modal {
  display:none; position:fixed; z-index:5000; left:0; top:0;
  width:100%; height:100%; overflow:auto;
  background-color:rgba(0,0,0,0.6); justify-content:center; align-items:center;
}
.modal-content {
  background:#fff; padding:20px; border-radius:8px; max-width:800px; width:90%;
  max-height:90%; overflow-y:auto;
  box-shadow:0 4px 12px rgba(0,0,0,0.5);
}
.modal-content.dark { background:#222; color:#eee; }
.modal-close {
  color:#aaa; float:right; font-size:24px; font-weight:bold; cursor:pointer;
}
.modal-close:hover { color:black; }

#aboutBtn { display:block; margin:10px 0; padding:6px 10px; cursor:pointer; background:#eee; border:none; border-radius:4px; }
#aboutBtn.dark { background:#555; color:white; }
</style>
</head>
<body>

<div class="sidebar" id="layerMenu">
  <div class="sidebar-header" id="dragHandle">Calques GeoJSON (dÃ©placer ici)</div>
  <button id="toggleDark">Basculer clair/sombre</button>
  <button id="aboutBtn">Ã€ propos</button>

  <details open>
    <summary>DÃ©partement de la Loire</summary>
    <div id="departementLayers"></div>
    <label for="communeSelect"><b>Zoom sur une commune :</b></label>
    <select id="communeSelect"><option value="">-- Choisir une commune --</option></select>
  </details>

  <details open>
    <summary>Gestion des risques</summary>
    <div id="riskLayers"></div>
  </details>

  <details open>
    <summary>Associations AgrÃ©Ã©es de SÃ©curitÃ© Civile</summary>
    <div id="AASCLayers"></div>
  </details>

  <details open>
    <summary>DÃ©partements de Corse</summary>
    <div id="CorseLayers"></div>
    <label for="communeCorseSelect"><b>Zoom sur une commune :</b></label>
    <select id="communeCorseSelect"><option value="">-- Choisir une commune --</option></select>
  </details>

  <div id="legend"><b>LÃ©gende :</b><br>â€“ aucun calque actif â€“</div>
  <div id="errorMessages"></div>
  <img id="sidebarLogo" src="images/Logo_F4EED.png" alt="Logo D42">
</div>

<div id="map"></div>
<div id="coords">DÃ©placez la souris sur la carte...</div>
<div id="versionFloating" title="DÃ©placez pour mÃ©moriser la position"></div>

<!-- Modale "Ã€ propos" -->
<div id="aboutModal" class="modal">
  <div class="modal-content" id="aboutContentContainer">
    <span class="modal-close">&times;</span>
    <img src="images/Logo_F4EED.png" alt="Logo D42" style="display:block; margin:10px auto; max-width:120px;">
    <h2 style="text-align:center;">Ã€ propos</h2>
    <div id="aboutContent">
      <!-- Changelog sera injectÃ© ici -->
    </div>
  </div>
</div>

<script src="js/leaflet.js"></script>
<script src="js/protomaps-leaflet.js"></script>
<script src="js/proj4.js"></script>

<script>
// === Carte
const map = L.map('map').setView([45.7885,4.1830],9);
protomapsL.leafletLayer({url:"pmtiles/mymap.pmtiles",flavor:'light',lang:'fr'}).addTo(map);

// === CoordonnÃ©es
const errorDiv = document.getElementById("errorMessages");
function showError(msg){ const p = document.createElement("div"); p.textContent="âš ï¸ "+msg; errorDiv.appendChild(p); }

proj4.defs("EPSG:2154","+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +units=m +no_defs");
proj4.defs("EPSG:32631","+proj=utm +zone=31 +datum=WGS84 +units=m +no_defs");

function latLonToUTM(lat, lon){ try{ const r=proj4("EPSG:4326","EPSG:32631",[lon,lat]); return {easting:Math.round(r[0]), northing:Math.round(r[1]), zoneNumber:31}; }catch(e){return{easting:"-",northing:"-",zoneNumber:"-"};} }
function latLonToLambert93(lat, lon){ try{ const r=proj4("EPSG:4326","EPSG:2154",[lon,lat]); return 'X:'+Math.round(r[0])+' Y:'+Math.round(r[1]); }catch(e){return 'â€“';} }
function latLonToDFCI(lat, lon){ try{ const X=Math.floor((lon+10)/0.01); const Y=Math.floor((lat+50)/0.01); return 'DFCI '+X+'-'+Y; }catch(e){ return 'â€“'; } }

const coordsDiv = document.getElementById('coords');
let currentToponyme = null;
map.on('mousemove', e=>{
  const lat=e.latlng.lat, lon=e.latlng.lng;
  const utm=latLonToUTM(lat,lon), lambert=latLonToLambert93(lat,lon), dfci=latLonToDFCI(lat,lon);
  coordsDiv.innerHTML=`Lat:${lat.toFixed(5)}, Lon:${lon.toFixed(5)} | Zoom:${map.getZoom()}`
  +` | UTM:${utm.easting},${utm.northing} (Zone ${utm.zoneNumber})`
  +` | DFCI:${dfci} | Lambert93:${lambert}`+(currentToponyme?' | '+currentToponyme:'');
});

// === IcÃ´nes
const icons={ 
  "Point de RepÃ¨re routier":L.icon({iconUrl:'images/PR.png',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}), 
  "Centre d'Icendie et Secours":L.icon({iconUrl:'images/CIS.png',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}), 
  "Entreprises SEVESO":L.icon({iconUrl:'images/SEVEZO.png',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]})
};

// === Layers
const layers={}, communesLoireIndex={}, communesCorseIndex={};
let highlightLayer=null, highlightCorseLayer=null;

const geojsonFiles={
  departement:[
    {name:"Point de RepÃ¨re routier", file:"geojson/D42/PR_Routier.geojson", style:{color:"blue", weight:3}, minZoom:14, noAutoZoom:true},
    {name:"Communes de La Loire", file:"geojson/D42/communes-42-loire.geojson", style:{color:"#A0522D", weight:2, dashArray:"4 4", fill:false}, isCommuneList:true},
    {name:"Habitation", file:"geojson/D42/Zone_habitation.geojson", style:{color:"darkred", weight:3}, noAutoZoom:true},
    {name:"Lieu dit :: non habitable", file:"geojson/D42/Lieu_dit_non_habite.geojson", style:{color:"darkred", weight:3}, minZoom:16, noAutoZoom:true},
    {name:"Lieu dit :: habitable", file:"geojson/D42/Toponyme.geojson", style:{color:"darkred", weight:3}, minZoom:16, noAutoZoom:true}
  ],
  risks:[
    {name:"Centre d'Icendie et Secours", file:"geojson/D42/CIS.geojson", style:{color:"red", weight:2, dashArray:'4 4'}, noAutoZoom:true},
    {name:"Entreprises SEVESO", file:"geojson/D42/Ets_SEVESO.geojson", style:{color:"darkred", weight:3}, noAutoZoom:true}
  ],
  AASC:[
    {name:"PIO UDIOM(42)", file:"geojson/D42/UDIOM42.geojson", style:{color:"red", weight:2, dashArray:'4 4'}}
  ],
  Corse:[
    {name:"Communes Corse", file:"geojson/Corse/communes-corse.geojson", style:{color:"#A0522D", weight:2, dashArray:"4 4", fill:false}, isCommuneList:true},
    {name:"TKNet", file:"geojson/Corse/TKNET.geojson", style:{color:"green", weight:2, dashArray:"3 3"}, minZoom:10}
  ]
};

// === Fonctions pour layers
function addCheckbox(div,name,layer,noAutoZoom){
  const id="chk_"+name.replace(/\s+/g,'_');
  const label=document.createElement("label");
  label.htmlFor=id;
  const checkbox=document.createElement("input");
  checkbox.type="checkbox"; checkbox.id=id;
  checkbox.addEventListener("change", e=>{
    if(e.target.checked){ layer.addTo(map); if(!noAutoZoom && layer.getBounds) map.fitBounds(layer.getBounds(),{padding:[20,20]}); updateLegend(); }
    else { map.removeLayer(layer); updateLegend(); }
  });
  label.appendChild(checkbox);
  label.appendChild(document.createTextNode(" "+name));
  div.appendChild(label);
}

async function loadGeoJSONLayer(item){
  try{
    const res=await fetch(item.file);
    if(!res.ok) throw new Error("Impossible de charger "+item.file);
    const geojson=await res.json();
    const layer=L.geoJSON(geojson,{
      style:item.style,
      pointToLayer:(f,latlng)=> icons[item.name]? L.marker(latlng,{icon:icons[item.name]}):L.circleMarker(latlng,item.style),
      onEachFeature:(feature,l)=>{
        if(feature.properties){
          let popup=""; for(const key in feature.properties) popup+=`<b>${key}:</b> ${feature.properties[key]}<br>`;
          l.bindPopup(popup);
        }
        if(item.isCommuneList){
          const index=item.name==="Communes de La Loire"? communesLoireIndex:communesCorseIndex;
          index[feature.properties.code]=feature;
          const select=document.getElementById(item.name==="Communes de La Loire"?"communeSelect":"communeCorseSelect");
          const opt=document.createElement("option"); opt.value=feature.properties.code; opt.textContent=feature.properties.nom; select.appendChild(opt);
          l.on('mouseover',()=> currentToponyme=feature.properties.nom);
          l.on('mouseout',()=> currentToponyme=null);
        }
      }
    });
    layers[item.name]=layer;
    return layer;
  }catch(err){ console.error(err); showError("Erreur chargement : "+item.file); return null; }
}

async function setupLayers(){
  for(const [cat,items] of Object.entries(geojsonFiles)){
    const div=document.getElementById(
      cat==="departement"?"departementLayers":
      cat==="risks"?"riskLayers":
      cat==="AASC"?"AASCLayers":"CorseLayers"
    );
    for(const item of items){ const layer=await loadGeoJSONLayer(item); if(layer) addCheckbox(div,item.name,layer,item.noAutoZoom); }
  }

  document.getElementById("communeSelect").addEventListener("change", e=>{
    const code=e.target.value; if(!code||!communesLoireIndex[code]) return;
    if(highlightLayer) map.removeLayer(highlightLayer);
    highlightLayer=L.geoJSON(communesLoireIndex[code],{style:{color:"blue",weight:3,fillOpacity:0.3}}).addTo(map);
    map.fitBounds(highlightLayer.getBounds(),{padding:[20,20]});
    setTimeout(()=>{ map.removeLayer(highlightLayer); highlightLayer=null; },8000);
  });
  document.getElementById("communeCorseSelect").addEventListener("change", e=>{
    const code=e.target.value; if(!code||!communesCorseIndex[code]) return;
    if(highlightCorseLayer) map.removeLayer(highlightCorseLayer);
    highlightCorseLayer=L.geoJSON(communesCorseIndex[code],{style:{color:"blue",weight:3,fillOpacity:0.3}}).addTo(map);
    map.fitBounds(highlightCorseLayer.getBounds(),{padding:[20,20]});
    setTimeout(()=>{ map.removeLayer(highlightCorseLayer); highlightCorseLayer=null; },8000);
  });
}
setupLayers();

// === LÃ©gende dynamique
function updateLegend(){
  const legendDiv=document.getElementById("legend");
  const activeLayers=Object.keys(layers).filter(name=>map.hasLayer(layers[name]));
  if(activeLayers.length===0){ legendDiv.innerHTML="<b>LÃ©gende :</b><br>â€“ aucun calque actif â€“"; return; }
  let html="<b>LÃ©gende :</b><br>";
  activeLayers.forEach(name=>{
    if(icons[name]){
      html+=`<div style="display:flex; align-items:center; margin-bottom:4px;">
                <img src="${icons[name].options.iconUrl}" style="width:20px; height:20px; margin-right:6px;">
                ${name}</div>`;
    } else {
      const color=layers[name].options.style?.color||'#000';
      const weight=layers[name].options.style?.weight||3;
      html+=`<div style="display:flex; align-items:center; margin-bottom:4px;">
                <span style="display:inline-block; width:20px; height:${weight}px; background:${color}; margin-right:6px;"></span>
                ${name}</div>`;
    }
  });
  legendDiv.innerHTML=html;
}

// === Toggle sombre
document.getElementById("toggleDark").addEventListener("click",()=>{
  document.body.classList.toggle("dark");
  document.querySelector(".sidebar").classList.toggle("dark");
  document.getElementById("aboutBtn").classList.toggle("dark");
  document.getElementById("aboutContentContainer").classList.toggle("dark");
});

// === Version flottante
const versionBox=document.getElementById("versionFloating");
function updateVersionBox(){ 
  const d=new Date(); 
  versionBox.textContent="cartoff - V1.5-plan | "+d.toLocaleDateString()+" "+d.toLocaleTimeString().slice(0,5); 
}
setInterval(updateVersionBox,1000); 
updateVersionBox();

let isDragging=false,offsetX=0,offsetY=0;
versionBox.addEventListener("mousedown",e=>{isDragging=true;offsetX=e.clientX-versionBox.offsetLeft;offsetY=e.clientY-versionBox.offsetTop;});
document.addEventListener("mouseup",()=>isDragging=false);
document.addEventListener("mousemove",e=>{if(isDragging){versionBox.style.left=(e.clientX-offsetX)+"px";versionBox.style.top=(e.clientY-offsetY)+"px"; versionBox.style.transform="none";}});

// === Changelog HTML
const changelogHTML = `
<table style="width:100%; border-collapse: collapse;">
<tr><th>Version</th><th>Date</th><th>Auteurs</th><th>Notes principales</th></tr>
<tr><td><b>V1.5-plan</b></td><td>09/09/2025</td><td>ChatGPT, FrÃ©dÃ©ric Bouchet, Valentin Saugnier</td><td>ğŸ†• Bouton Â« Ã€ propos Â» avec modale Ã©lÃ©gante et logo<br>ğŸŒ— Mode sombre appliquÃ© Ã  la sidebar et Ã  la modale<br>ğŸ–¼ï¸ LÃ©gende dynamique enrichie avec icÃ´nes et symbologie des calques<br>âœ… Conservation de toutes les fonctionnalitÃ©s de la V1.4-stable<br>ğŸ› Corrections mineures</td></tr>
<tr><td><b>V1.4-stable</b></td><td>15/08/2025</td><td>FrÃ©dÃ©ric Bouchet, Valentin Saugnier</td><td>ğŸ–¼ï¸ LÃ©gende dynamique<br>ğŸ“ CoordonnÃ©es et suivi du toponyme<br>ğŸ—ºï¸ Calques GeoJSON<br>ğŸ“Œ Zoom sur communes<br>ğŸ› ï¸ Iconographie PR, CIS, SEVESO<br>ğŸŒ— Mode clair/sombre<br>â±ï¸ Version flottante</td></tr>
<tr><td><b>V1.3</b></td><td>01/07/2025</td><td>FrÃ©dÃ©ric Bouchet, Valentin Saugnier</td><td>ğŸ—ºï¸ Calques Loire<br>ğŸ” Zoom sur communes<br>ğŸ“œ LÃ©gende statique<br>â±ï¸ Version flottante<br>ğŸŒ Mode clair par dÃ©faut</td></tr>
<tr><td><b>V1.2</b></td><td>15/06/2025</td><td>FrÃ©dÃ©ric Bouchet</td><td>âš ï¸ Calques risques et SEVESO<br>ğŸ’¬ Popups par feature<br>ğŸ›¡ï¸ Layer AASC</td></tr>
<tr><td><b>V1.1</b></td><td>01/06/2025</td><td>FrÃ©dÃ©ric Bouchet</td><td>ğŸ—‚ï¸ Sidebar avec checkboxes<br>ğŸ–¼ï¸ IcÃ´nes points dâ€™intÃ©rÃªt<br>ğŸ” Zoom automatique</td></tr>
<tr><td><b>V1.0</b></td><td>01/05/2025</td><td>FrÃ©dÃ©ric Bouchet</td><td>ğŸš€ Carte PMTiles hors-ligne<br>ğŸ—‚ï¸ Chargement statique GeoJSON<br>ğŸ–¥ï¸ Sidebar simple<br>ğŸ“ CoordonnÃ©es Lat/Lon</td></tr>
</table>
`;
document.getElementById('aboutContent').innerHTML = changelogHTML;

// === Modale "Ã€ propos"
const aboutModal=document.getElementById("aboutModal");
const aboutBtn=document.getElementById("aboutBtn");
const closeBtn=document.querySelector(".modal-close");

aboutBtn.onclick=()=>{ aboutModal.style.display="flex"; }
closeBtn.onclick=()=>{ aboutModal.style.display="none"; }
window.onclick=e=>{ if(e.target==aboutModal) aboutModal.style.display="none"; }
</script>
</body>
</html>
