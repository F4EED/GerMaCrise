<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Structures - GerMaCrise</title>
  <style>
    body {
      margin:0;
      font-family:Arial,sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    body.light {
      background-color:#ffffff;
      color:#000000;
    }
    body.dark {
      background-color:#000000;
      color:#ff8800; /* orange harmonis√© */
    }

    header { padding:10px; font-size:1.2em; font-weight:bold; }
    h2 { margin-top:0; }

    .form-section { margin:15px; }
    label { display:block; margin-top:10px; }
    input { width:100%; padding:5px; margin-top:3px; }
    button { margin-top:10px; padding:5px 10px; cursor:pointer; }

    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #999; padding:5px; text-align:left; }
    th { background-color:rgba(0,0,0,0.1); }

    /* Th√®me sombre */
    body.dark table th { background-color:rgba(255,136,0,0.2); }
    body.dark input, body.dark button {
      background-color:#222;
      color:#ff8800;
      border:1px solid #ff8800;
    }

    p.instruction { font-size:0.9em; color:gray; margin-top:5px; }
    body.dark p.instruction { color:#ff8800; }
  </style>
</head>
<body class="light">
  <header>Gestion des structures - GerMaCrise</header>

  <!-- Liste -->
  <div class="form-section">
    <h2>Liste des structures</h2>
    <table id="tableStructures">
      <thead>
        <tr><th>Nom</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="exporterJSON()">üì• Exporter en JSON</button>
    <p class="instruction">
      ‚ö†Ô∏è Pour mettre √† jour la source, d√©placez le fichier t√©l√©charg√© dans le dossier <code>json/</code>.
    </p>
  </div>

  <!-- Formulaire -->
  <div class="form-section">
    <h2>Ajouter / Modifier une structure</h2>
    <label>Nom <input type="text" id="nomStructure"></label>
    <button onclick="ajouterStructure()">Ajouter / Modifier</button>
    <button onclick="resetForm()">Annuler</button>
  </div>

  <script>
    // === Appliquer le th√®me stock√© au premier chargement
    document.addEventListener('DOMContentLoaded', ()=>{
      const theme = localStorage.getItem('theme') || 'light';
      document.body.className = theme;
    });

    // === R√©ception du th√®me depuis le parent (index.html)
    window.addEventListener('message', e => {
      if(e.data.theme){
        document.body.className = e.data.theme;
        localStorage.setItem('theme', e.data.theme);
      }
    });

    let structures = [];
    let editIndex = null;

    async function chargerStructures() {
      try {
        const resp = await fetch("json/structure.json");
        if(!resp.ok) throw new Error("Fichier JSON introuvable");
        structures = await resp.json();
      } catch(e) {
        const data = localStorage.getItem("structures");
        structures = data ? JSON.parse(data) : [];
      }
      afficherStructures();
    }

    function sauvegarderStructures() {
      localStorage.setItem("structures", JSON.stringify(structures));
    }

    function ajouterStructure() {
      const nom = document.getElementById('nomStructure').value.trim();
      if(!nom) {
        alert("Veuillez remplir le nom de la structure");
        return;
      }

      if(editIndex !== null) {
        structures[editIndex] = {nom};
        editIndex = null;
      } else {
        structures.push({nom});
      }

      sauvegarderStructures();
      afficherStructures();
      resetForm();
    }

    function afficherStructures() {
      const tbody = document.getElementById('tableStructures').querySelector('tbody');
      tbody.innerHTML = '';
      structures.forEach((s, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.nom}</td>
          <td>
            <button onclick="modifierStructure(${index})">‚úè</button>
            <button onclick="supprimerStructure(${index})">üóë</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function modifierStructure(index) {
      document.getElementById('nomStructure').value = structures[index].nom;
      editIndex = index;
    }

    function supprimerStructure(index) {
      if(confirm("Supprimer cette structure ?")) {
        structures.splice(index,1);
        sauvegarderStructures();
        afficherStructures();
      }
    }

    function resetForm() {
      document.getElementById('nomStructure').value = '';
      editIndex = null;
    }

    function exporterJSON() {
      const dataStr = JSON.stringify(structures, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "structure.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialisation
    chargerStructures();
  </script>
</body>
</html>
