<!-- 
  ===============================================
  Projet cartoff - cartographie offline
  Version : V1.2-stable
  Auteurs : ChatGPT - Frédéric Bouchet, Valentin Saugnier
  Description :
    - Carte Leaflet 100% offline avec fond vectoriel .pmtiles
    - Gestion de calques GeoJSON par catégories et groupes
    - Légende améliorée avec nombre de features actifs
    - Sélecteurs pour zoom sur communes (Loire & Corse)
    - Affichage coordonnées en degré, UTM et DFCI
    - Contrôle flottant version+date+heure, déplaçable et mémorisé
    - Mode sombre / clair toggle
  ===============================================
-->

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>cartoff - V1.2-squelette</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="css/leaflet.css" />
<style>
html, body { margin:0; height:100%; }
#map { width:100%; height:100vh; background:#ccc; transition: background 0.3s; }

/* Sidebar */
.sidebar { 
  position:absolute; top:10px; right:10px; z-index:2000; 
  background:white; padding:10px; border-radius:8px; 
  box-shadow:0 2px 6px rgba(0,0,0,0.3); max-width:300px; 
  font-family:Arial,sans-serif; font-size:14px; 
  user-select:none; transition: background 0.3s, color 0.3s;
}
.sidebar.dark { background:#222; color:#eee; box-shadow:0 2px 6px rgba(0,0,0,0.6);}
.sidebar-header { cursor: grab; font-weight:bold; margin-bottom:8px; }
details summary { cursor:pointer; font-weight:bold; }
details { margin-bottom:5px; }
label { cursor:pointer; display:block; }

/* Coordonnées */
#coords { 
  position:absolute; bottom:10px; left:10px; z-index:3000; 
  background:rgba(255,255,255,0.9); padding:6px 10px; 
  border-radius:6px; font-family:Arial,sans-serif; font-size:13px; 
  box-shadow:0 1px 4px rgba(0,0,0,0.3); min-width:260px; 
  user-select:none; pointer-events:none; transition: background 0.3s, color 0.3s;
}

/* Légende */
#legend { margin-top:10px; border-top:1px solid #ccc; padding-top:5px; font-size:13px; }
#sidebarLogo { display:block; margin:10px auto 0 auto; max-width:100%; }

/* Version flottante */
#versionFloating{
  position:absolute; z-index:4000; background: rgba(0,0,0,0.7); color:white; 
  padding:4px 8px; border-radius:6px; font-family:Arial,sans-serif; font-size:12px; 
  cursor:move; user-select:none; text-align:center;
}

/* Mode sombre */
body.dark #map { background:#444; }
body.dark #coords { background: rgba(50,50,50,0.8); color:white; }
</style>
</head>
<body>
<div class="sidebar" id="layerMenu">
  <div class="sidebar-header" id="dragHandle">Calques GeoJSON (déplacer ici)</div>
  
  <button id="toggleDark">Mode sombre</button>

  <details open>
    <summary>Département de la Loire</summary>
    <div id="departementLayers"></div>
    <label for="communeSelect"><b>Zoom sur une commune :</b></label>
    <select id="communeSelect"><option value="">-- Choisir une commune --</option></select>
  </details>

  <details open>
    <summary>Gestion des risques</summary>
    <div id="riskLayers"></div>
  </details>

  <details open>
    <summary>Associations Agréées de Sécurité Civile</summary>
    <div id="AASCLayers"></div>
  </details>

  <details open>
    <summary>Départements de Corse</summary>
    <div id="CorseLayers"></div>
    <label for="communeCorseSelect"><b>Zoom sur une commune :</b></label>
    <select id="communeCorseSelect"><option value="">-- Choisir une commune --</option></select>
  </details>

  <div id="legend"><b>Légende :</b><br>– aucun calque actif –</div>
  <img src="images/Logo_F4EED.png" id="sidebarLogo" alt="Logo D42">
</div>

<div id="map"></div>
<div id="coords">Déplacez la souris sur la carte...</div>
<div id="versionFloating"></div>

<script src="js/leaflet.js"></script>
<script src="js/protomaps-leaflet.js"></script>
<script>
// =============================
// Initialisation carte Leaflet
// =============================
const map = L.map('map').setView([45.7885,4.1830],9);
protomapsL.leafletLayer({url:"pmtiles/mymap.pmtiles",flavor:'light',lang:'fr'}).addTo(map);

// =============================
// Coordonnées
// =============================
const coordsDiv = document.getElementById('coords');
let currentToponyme = null;

// =============================
// Conversion Lat/Lon → UTM
// =============================
function latLonToUTM(lat, lon){
  const zoneNumber = Math.floor((lon + 180)/6)+1;
  const latRad = lat*Math.PI/180;
  const lonOrigin = (zoneNumber-1)*6-180+3;
  const lonOriginRad = lonOrigin*Math.PI/180;
  const a=6378137, f=1/298.257223563;
  const k0=0.9996;
  const e = Math.sqrt(f*(2-f));
  const N = a/Math.sqrt(1-e*e*Math.sin(latRad)*Math.sin(latRad));
  const T = Math.tan(latRad)*Math.tan(latRad);
  const C = (e*e)/(1-e*e)*Math.cos(latRad)*Math.cos(latRad);
  const A = Math.cos(latRad)*(lon-lonOrigin)*Math.PI/180;
  const M = a*((1 - e*e/4 -3*e*e*e*e/64 -5*e*e*e*e*e*e/256)*latRad
             - (3*e*e/8 +3*e*e*e*e/32 +45*e*e*e*e*e*e/1024)*Math.sin(2*latRad)
             + (15*e*e*e*e/256 +45*e*e*e*e*e*e/1024)*Math.sin(4*latRad)
             - (35*e*e*e*e*e*e/3072)*Math.sin(6*latRad));
  const easting = k0*N*(A + (1-T+C)*A*A*A/6 + (5 -18*T + T*T +72*C -58*(e*e)/(1-e*e))*A*A*A*A*A/120)+500000;
  const northing = k0*(M+N*Math.tan(latRad)*(A*A/2 + (5-T+9*C+4*C*C)*A*A*A*A/24 +(61 -58*T + T*T +600*C -330*(e*e)/(1-e*e))*A*A*A*A*A*A/720));
  return {easting: Math.round(easting), northing: Math.round(northing), zoneNumber};
}

// =============================
// Conversion Lat/Lon → DFCI
// =============================
function latLonToDFCI(lat, lon){
  const latOrigin = 41.0; // Sud France
  const lonOrigin = -5.0; // Ouest France
  const latIndex = Math.floor((lat - latOrigin)/0.0083333); // ~1km
  const lonIndex = Math.floor((lon - lonOrigin)/0.0133333);
  const letters="ABCDEFGHJKLMNPQRSTUVWXYZ";
  const row = letters[Math.min(Math.max(latIndex,0),letters.length-1)];
  const col = letters[Math.min(Math.max(lonIndex,0),letters.length-1)];
  const x = Math.floor(((lon-lonOrigin)/0.0133333)%1000);
  const y = Math.floor(((lat-latOrigin)/0.0083333)%1000);
  return `${row}${col} ${x} ${y}`;
}

// =============================
// Affichage coordonnées
// =============================
map.on('mousemove', e=>{
  const lat=e.latlng.lat;
  const lon=e.latlng.lng;
  const utm=latLonToUTM(lat,lon);
  const dfci=latLonToDFCI(lat,lon);
  coordsDiv.innerHTML=`Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)} | Zoom: ${map.getZoom()} | UTM: ${utm.easting},${utm.northing} (Zone ${utm.zoneNumber}) | DFCI: ${dfci}${currentToponyme?' | '+currentToponyme:''}`;
});

// =============================
// Icônes
// =============================
const icons={
  "Point de Repère routier":L.icon({iconUrl:'images/PR.png',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}),
  "Centre d'Icendie et Secours":L.icon({iconUrl:'images/CIS.png',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}),
  "Entreprises SEVESO":L.icon({iconUrl:'images/SEVEZO.png',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]})
};

// =============================
// Variables
// =============================
const layers={},communesLoireIndex={},communesCorseIndex={};
let highlightLayer=null,highlightCorseLayer=null;

// =============================
// GeoJSON
// =============================
const geojsonFiles = {
  departement:[
    {name:"Point de Repère routier",file:"geojson/D42/PR_Routier.geojson",style:{color:"blue",weight:3},minZoom:14,noAutoZoom:true},
    {name:"Communes de La Loire",file:"geojson/D42/communes-42-loire.geojson",style:{color:"#A0522D",weight:2,dashArray:"4 4",fill:false},isCommuneList:true},
    {name:"Habitation",file:"geojson/D42/Zone_habitation.geojson",style:{color:"darkred",weight:3},noAutoZoom:true},
    {name:"Lieu dit :: non habitable",file:"geojson/D42/Lieu_dit_non_habite.geojson",style:{color:"darkred",weight:3},minZoom:16,noAutoZoom:true},
    {name:"Lieu dit :: habitable",file:"geojson/D42/Toponyme.geojson",style:{color:"darkred",weight:3},minZoom:16,noAutoZoom:true}
  ],
  risks:[
    {name:"Centre d'Icendie et Secours",file:"geojson/D42/CIS.geojson",style:{color:"red",weight:2,dashArray:'4 4'},noAutoZoom:true},
    {name:"Entreprises SEVESO",file:"geojson/D42/Ets_SEVESO.geojson",style:{color:"darkred",weight:3},noAutoZoom:true}
  ],
  AASC:[
    {name:"PIO UDIOM(42)",file:"geojson/D42/UDIOM42.geojson",style:{color:"red",weight:2,dashArray:'4 4'}}
  ],
  Corse:[
    {name:"Communes Corse",file:"geojson/Corse/communes-corse.geojson",style:{color:"#A0522D",weight:2,dashArray:"4 4",fill:false},isCommuneList:true},
    {name:"TKNet",file:"geojson/Corse/TKNET.geojson",style:{color:"green",weight:2,dashArray:"3 3"},minZoom:10}
  ]
};

// =============================
// Légende
// =============================
const legendDiv=document.getElementById('legend');
function updateLegend(){
  const active=Object.entries(layers).filter(([name,layer])=>map.hasLayer(layer));
  if(active.length===0) legendDiv.innerHTML="<b>Légende :</b><br>– aucun calque actif –";
  else legendDiv.innerHTML="<b>Légende :</b><br>"+active.map(([name,layer])=>"– "+name+" ("+layer.getLayers().length+" features)").join("<br>");
}

// =============================
// Chargement GeoJSON
// =============================
async function loadGeoJSONLayer(item){
  try{
    const res=await fetch(item.file);
    if(!res.ok) throw new Error("Erreur chargement "+item.file);
    const geojson=await res.json();
    const layer=L.geoJSON(geojson,{
      style:item.style,
      pointToLayer:(f,latlng)=>icons[item.name]?L.marker(latlng,{icon:icons[item.name]}):L.circleMarker(latlng,item.style),
      onEachFeature:(feature,l)=>{
        if(feature.properties){
          let popup="";
          for(const key in feature.properties) popup+=`<b>${key}:</b> ${feature.properties[key]}<br>`;
          l.bindPopup(popup);
        }
        if(item.isCommuneList){
          const index=item.name==="Communes de La Loire"?communesLoireIndex:communesCorseIndex;
          index[feature.properties.code]=feature;
          const select=document.getElementById(item.name==="Communes de La Loire"?"communeSelect":"communeCorseSelect");
          const opt=document.createElement("option");
          opt.value=feature.properties.code;
          opt.textContent=feature.properties.nom;
          select.appendChild(opt);

          l.on('mouseover',()=>currentToponyme=feature.properties.nom);
          l.on('mouseout',()=>currentToponyme=null);
        }
      }
    });
    layers[item.name]=layer;
    return layer;
  }catch(err){ console.error(err); alert(err); return null;}
}

// =============================
// Setup calques
// =============================
async function setupLayers(){
  for(const [cat,items] of Object.entries(geojsonFiles)){
    const div=document.getElementById(
      cat==="departement"? "departementLayers":
      cat==="risks"? "riskLayers":
      cat==="AASC"? "AASCLayers":
      "CorseLayers"
    );
    for(const item of items){
      const layer=await loadGeoJSONLayer(item);
      if(layer) addCheckbox(div,item.name,layer,item);
    }
  }

  document.getElementById("communeSelect").addEventListener("change",e=>{
    const code=e.target.value;
    if(!code||!communesLoireIndex[code]) return;
    if(highlightLayer) map.removeLayer(highlightLayer);
    highlightLayer=L.geoJSON(communesLoireIndex[code],{style:{color:"blue",weight:3,fillOpacity:0.3}}).addTo(map);
    map.fitBounds(highlightLayer.getBounds(),{padding:[20,20]});
    setTimeout(()=>{map.removeLayer(highlightLayer); highlightLayer=null; updateLegend();},8000);
  });

  document.getElementById("communeCorseSelect").addEventListener("change",e=>{
    const code=e.target.value;
    if(!code||!communesCorseIndex[code]) return;
    if(highlightCorseLayer) map.removeLayer(highlightCorseLayer);
    highlightCorseLayer=L.geoJSON(communesCorseIndex[code],{style:{color:"blue",weight:3,fillOpacity:0.3}}).addTo(map);
    map.fitBounds(highlightCorseLayer.getBounds(),{padding:[20,20]});
    setTimeout(()=>{map.removeLayer(highlightCorseLayer); highlightCorseLayer=null; updateLegend();},8000);
  });
}

setupLayers();

// =============================
// Checkbox
// =============================
function addCheckbox(div,name,layer,item){
  const id="chk_"+name.replace(/\s+/g,'_');
  const label=document.createElement("label");
  label.htmlFor=id;
  const checkbox=document.createElement("input");
  checkbox.type="checkbox";
  checkbox.id=id;
  checkbox.addEventListener("change",e=>{
    if(e.target.checked){
      layer.addTo(map);
      if(layer.getBounds && !item.noAutoZoom) map.fitBounds(layer.getBounds(),{padding:[20,20]});
    }else map.removeLayer(layer);
    updateLegend();
  });
  label.appendChild(checkbox);
  label.appendChild(document.createTextNode(" "+name));
  div.appendChild(label);
}

// =============================
// Version flottante
// =============================
const versionDiv=document.getElementById("versionFloating");
const version="V1.2-squelette";
function updateVersion(){
  const now=new Date();
  const dateStr=now.toLocaleDateString("fr-FR");
  const timeStr=now.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
  versionDiv.innerHTML=`<b>${version}</b> – ${dateStr} ${timeStr}`;
}
updateVersion();
setInterval(updateVersion,60*1000);

let savedPos=JSON.parse(localStorage.getItem("versionPos"));
if(savedPos){ versionDiv.style.left=savedPos.left; versionDiv.style.top=savedPos.top; }
else{ versionDiv.style.bottom="10px"; versionDiv.style.left="50%"; versionDiv.style.transform="translateX(-50%)"; }

let isDragging=false, offsetX=0, offsetY=0;
versionDiv.addEventListener('mousedown',e=>{
  isDragging=true;
  versionDiv.style.transform="none";
  offsetX=e.clientX-versionDiv.getBoundingClientRect().left;
  offsetY=e.clientY-versionDiv.getBoundingClientRect().top;
});
document.addEventListener('mousemove',e=>{
  if(!isDragging) return;
  versionDiv.style.left=(e.clientX-offsetX)+"px";
  versionDiv.style.top=(e.clientY-offsetY)+"px";
});
document.addEventListener('mouseup',e=>{
  if(isDragging){
    isDragging=false;
    localStorage.setItem("versionPos",JSON.stringify({left:versionDiv.style.left,top:versionDiv.style.top}));
  }
});

// =============================
// Mode sombre / clair toggle
// =============================
const darkBtn=document.getElementById("toggleDark");
darkBtn.addEventListener("click",()=>{
  document.body.classList.toggle("dark");
  document.querySelector(".sidebar").classList.toggle("dark");
});
</script>
</body>
</html>
